---
layout: post
title: 2014 US blackhat\: Smart Nest Thermostat \: A Smart Spy in Your Home
---

拖了好久才看完第一篇。

                          Smart Nest Thermostat \: A Smart Spy in Your Home

                   Grant Hernandez1, OrlandoArias1, Daniel Buentello2, and Yier Jin1

                    1 Security in Silicon Laboratory, University of CentralFlorida

                                      2 Independent Researcher

                                        yier.jin@eecs.ucf.edu

+ ***Abstract***

Nest Thermostat 是一个智能自动化家庭设备，它旨在通过学习用户升温和降温的习惯来优化计划和能源的使用。它于2011年首次亮相的时候，Nest就被证明是如此的成功以至于Google花费3.2Billion 美元收购这个公司。然而，Nest Theromostat中基础设施的复杂性提供了类似在其他计算机系统被发现的安全性漏洞繁殖的温床。为了减轻这个问题，Nest表示固件升级会推送到这些设备，但是，硬件基础设施缺乏基本的保护，这使得攻击者可以在元件中安装恶意软件。通过USB连接，我们演示了由Nest 软件栈执行的固件证明是如何被绕过的，这提供了完全改变元件行为的手段。被危害的Nest就会成为攻击局域网内其他节点的桥头堡。同时，存储在元件内部的任何信息对于攻击者来说都是柯获取的，此时，攻击者并不再需要物理接触设备。最后我们为智能设备的架构师和制造商提出了一个旨在帮助开发和建立安全硬件平台的解决方法。

 

+ ***Introduction***

近些年随着越来越多的智能设备被设计、制造和部署，物联网（Internet OF Things）和可穿戴设备的概念被广泛的接受。据估计，到2020年大概会有超过50 billion的网络连接设备，这其中的大多将会是物联网和可穿戴设备。曾经科幻小说中冰箱为我们定制牛奶和洗衣机在洗好衣服后通知我们的场景现在已经变为现实。

联网智能设备在提供便利的同时也产生了安全和隐私的问题。Nest组织的Tony Fadell在一次采访中声称：“我们拥有银行级别的安全，我们加密了更新，并且有一个内部黑客团队测试安全性，。。。如果用户不信任，（Nest Thermostat）是不会成功的“。然而，深入的去看现在的物联网和可穿戴设备的流程，我们会发现大多数的安全问题，如果有的话，是发生在应用层和网络层的。就是，设计者们经常将IoT和可穿戴设备当做标准的联网设备并且尝试应用被开发于通常每天所用的计算机设备上的安全保护。除了固件认证和加密，很少能发现做了其他工作。大多数IoT和可穿戴设备会搜集使用信息和其他数据并发送到服务提供者，这会导致隐私问题。对搜集了什么信息的充分披露是极少的，现在披露出来的数据都是在设备隐私条款和服务条款之内的。

Paper的其他部分，我们将介绍识别安全漏洞的工作，演示对系统的攻击。同时，从积极的角度我们提出同样的漏洞会提供给合法的用户用来抵抗隐私搜集的行为的方法。

+ ***The Nest Thermostant***

Nest Thermostant是一个被设计基于启发式和行为学习来控制中央空调的智能设备。Nest Thermostant 配备了wifi模块，这样就可以使用Nest云来连接使用者的家或者办公室，因此允许远程控制这个单元。它同时装备了ZigBee模块，可以与其他nest设备通信，但是到目前的4.2.X版本，这个功能一直处于休眠状态。

Nest Thermostant运行在一个Linux内核上，外加一些GNUuserland tools，Busybox和其他提供Nest Lab的私有栈的各种功能。为了保证遵从GPL，设备中使用的被修改的代码会发布并且可以再Nest Lab的开源网页 https://nest.com/legal/compliance 上下载，同时，还可以看到C库的值得注意的异常。但是build这些资源的工具链并没有被提供。

2.1  用户隐私 User Privacy

Nest Thermostat 会搜集设备使用统计和环境数据来“学习”用户行为。这些都被存储在元件中并且在联网的时候上传到Nest Cloud。不止使用统计会被上传，系统日志和Nest软件日志，其中包括诸如用户的ZipCode，设备设置，HVAC设置，接线配置等信息。对设备的取证分析表明Nest还有提供用户住所和办公室信息的代码。报告显示Nest计划与能源供应商分享这些信息以更有效的生产能源。

2.2  架构概览

作为设备本身，Nest被分为两个部分,如图1，一个直接有与空调单元连接的背面电极，和一个有显示屏，一个按钮，一个拨号盘和运动传感器的前端面板。操作系统运行于前端面板。

背面电极包括一个STMicroelectronics的低压ARM Cortex-M3微型控制器，包含128kb闪存和16kbRAM，外加一些驱动电路和一个SHT20温度湿度传感器。后端与前端通过UART进行通信。

前端面板有一个德州仪器SitaraAM3703微处理器，64MB的SDRAM，256MB的ECC NAND闪存，一个ZigBee模块和一个支持802.11b/g/n的Wifi模块。设备板上提供了德州仪器的TPS65921B能量管理模块，其上有HSUSB功能。Nest的这部分到目前为止使我们的研究目标，因为它提供了大多数的硬件并且处理所有的用户数据和输入。

![_config.yml]({{ site.baseurl }}/images/2014-9-10-1.png)

图1 设备架构概览

2.3  启动引导过程

达到正常条件功率时SitaraAM3703开始执行内部ROM之中的代码。代码初始化最基本的外围设备，包括通用内存控制器（General Purpose Memory Controller (GPMC)）。然后寻找第一阶段引导程序x-loader，将它装入SRAM。一旦这个操作执行完毕，ROM代码跳转到x-loader，继续初始化其他外围设备和SDRAM。随后，它将第二阶段引导程序u-boot拷入SDRAM并且继续执行。在这一阶段，u-boot继续初始化剩余子系统并使用预设环境执行NAND中的uImage。当系统的所有初始化脚本运行完毕，服务运行，Nest专有软件栈最高时完成引导。图2显示了基本引导过程

![_config.yml]({{ site.baseurl }}/images/2014-9-10-2.png)

图2 设备引导过程

+ ***TheAM3703 - A Closer Look***

德州仪器 AM3703组成如下：一个32通道DMA控制器，一个双输出三层显示处理器（a dual-output three-layer display processor），一个有USB OTG功能的高速USB控制器，一个调试用的模拟模块，一个处理NAND/NOR闪存的通用存储控制器（GPMC），一个SDRAM存储调度和控制器，一个112KB包含引导程序的芯片上的ROM和一个64KB连接所有运行在200MHz的L3（Level 3）关联（L3interconnect）的SRAM。

ARM核与其内部的MPU子系统使用256KB的cache访问L3关联（L3interconnect）。此外，L4关联增加了内存映射中的外围模块。这个外围模块负责处理GPIO，UARTs，高速多路I2C总线，内存卡控制器，记忆棒专有控制器（memory stick pro controller），看门狗计时器（watchdogtimer），通用计时器和其他各种子系统。

ARM子片（The ARMsubchip）结合了一个ARM Cortex-A8核，使用Version 7 指令集架构，提供标准的ARM指令，Thumb-2模式，JazelleXjava加速器和媒体扩展。它同事包含一个ARM NEON核SIMD协处理器。它连接到一个32KiB/32KiB指令/数据cache，这个cache继续连接着一个256KB8-way的支持奇偶校验和ECC的联合cache。核也提供了跟踪和调试属性。图3显示了简单的设备映射图。

![_config.yml]({{ site.baseurl }}/images/2014-9-10-3.png)

图3 设备映射图

3.1  设备初始化（Deviceinitialization）

电源连接后，时钟和复位信号在AM3703引导之前合适的初始化。设备引导配置通过6个外部管脚sys_boot[5:0]进行输入。Power-onreset后，这些管脚的值被状态寄存器CONTROL.CONTROL STATUS锁住。

在基本初始化任务执行完毕后，如果sys_boot引脚数据依照配置，那么芯片上的ROM会跳转到连接的执行内存（XIP）。引导模式会作为盲跳到外部可寻址内存，这一步只要可执行的时候就会执行（as soon as possible）。否则，ROM创建一个用来搜索引导镜像的引导设备表并把它存在可用的高速暂存存储器的第一个位置。引导表的建立取决于设备是否从power-on reset状态进行引导。如果设备从power-on reset状态引导，引导配置直接读取于sys_boot针脚并且锁入CONTROL.CONTROLSTATUS寄存器中。否则，ROM会在SRAM的暂存器中寻找一个可用的引导配置，如果找到了，就使用，否则，就会从永久（存储）设备中建立一个作为引脚的配置（otherwise it will build one from permanent devicesas configured in the sys_boot pins）。

在若干环境下进一步考察这个过程，有可能从像UART或USB这样的外围设备中进行引导。这个就是我们使用的在固件认证起作用之前将我们的代码插入到Nest中的方法。

+ ***攻击向量（Attack Vector）***

设备全局重置可以通过按下按键约10s触发。除其他事项外，这个操作引起sys _boot5针脚高电平，触发外围引导。巧合的，sys _boot5针脚直接暴露在主电路板上的一个未使用的数据头（an unpopulated header），这个数据头可以用来直接触发USB引导。由于ROM并没有密码学的检查要装载的代码，于是它可以自由执行，最终完全控制设备。这个过程的一些局限性必须被关注。有一个严格的时间窗，在这个时间窗里，ROM会一直监听所有的进入的程序数据；初始化载荷必须是x-loader，他会拷贝到SRAM中并必须初始化其他剩余子系统。剩余的载荷必须能适应并运行在SDRAM中。

4.1  初始化攻击（Initial attack）

我们的初始化攻击包括向设备发送x-loader，通过使用USB引导定制的u-boot镜像和包含最终载荷的虚拟盘的方式。我们的u-boot被配置为引导板子上的内核，利用虚拟盘作为初始根文件系统使我们能够在Nest根文件系统中自动化完成我们的后门。载荷安装设备的文件系统，使用一个已经存在的，我们通过修改Nest的bootscript创造的shell：netcat二进制文件。我们在https://www.youtube.com/watch?v=7AnvTgAKa-g 网址中演示了这个过程。

使用这个后门，我们能够开始探索这个设备的文件系统，尝试重建一个对用户群“消失”的items，也就是说，使用的C库的版本和build它使用的工具链的任何信息。一旦系统的C库被发现和探索，这些信息就是可获取的。一旦工具链被重构，我们就能在设备上运行自己的代码。将软件装载进设备可以使用这三种方法之一：1）使用netcat 2）执行上述攻击的虚拟盘 3）一旦完全引导并且连接到PC，Nest就会被识别并被当做USB大容量存储设备的事实。

4.2  精制后门

使用手中的工具链，我们可以交叉编译一个SHH server – dropbear，将它安装在设备上。在/etc/passwd , /etc/shadow, /etc/groups上做要求的改变可以加入一个用户账户。在改写初始化脚本时，我们注意到Nest尝试启用一个自己的secureshell server，但是文件系统现在不存在这个二进制文件。接下来的分析显示在这时一对RSA和DSA主机密钥产生。通过检查不同的单元发现这些key是唯一的。

在设备中运行一个secure shell server提供了局域网内的简单的访问。现在的问题是这些网络通常在NAT防火墙之后，这就使没用用户介入下不允许远程访问。我们继续验证了一个运行在Nest中的概念客户端软件并且通过我们发现的后门安装了它。这个客户端会尝试连接到远程服务器并且返回信息，证明将Nest设备作为大的僵尸网络一部分的可能性。

4.3  修改Linux内核

对设备的更深入的分析产生了现在的文件系统/proc目录中的压缩内核配置文件。为了更深入的研究设备的操作，我们小组开始开发一个基于附加了调试特征的公开资源的自定义Linux内核。为了避免每次都重新上载内核，我们将u-boot的信息转到了一个永久存储的地方。NAND的布局如图4：
 
![_config.yml]({{ site.baseurl }}/images/2014-9-10-4.png)

图4 NAND Layout

补丁需要被添加到kerneltree 中以便查询OMAP串口驱动，允许我们连接设备中可用的kgdb接口并捕获确定行为。我们向NAND  boot1区域下的单元永久的写入了这个kernel。然后我们使用自定义的u-boot来选择加电的时候引导哪个kernel。

Nest Lab 提供了定期更新Nest 固件。在写这个文章的时候，最新的固件版本是4.2.3.在NestUplaoder以root身份运行时，它会完全的访问文件系统（的权限），意味着会尝试删除以前区块上的后门。通过使用自定义kernel，我们插入了我们自己的改动以致会保护我们的软件防止被修改。控制着kernel区域意味着能够控制用户区域，这就意味着我们可以在设备中部署rootkit，如果我们愿意的话。

+ ***后果（影响）***

正如所演示的，Nest设备会在运输，部署或者在非安全区域被攻击者访问的过程中很容易的陷入危险（be compromised）。如上述演示，之后他会变成僵尸网络中的一个客户端。现在，使用我们虚拟盘的方法和写入自定义kernel的方法安装rootkit是可行的。自定义kernel会用来隐藏僵尸网络软件，僵尸网络软件会远程控制Nest，将它变成远程控制的桥头堡。

此外，在网络中陷入危险的Nest能够被用来进行欺骗服务（canbe used to introduce rogue services）。如果网络内部使用DHCP，Nest能够扮演DHCP server的角色。当一个用户节点尝试获取IP地址和DNS server时，使用我们自己的DNS      server的响应就会给用户，因此，控制了向哪个IP解析哪个地址。Nest也能像一个路由器一样伪装ARP包，这是得允许捕获目标计算机的网络流量。

Nest后门在局域网证书存储在设备中并且能被我们的软件访问到的情况下危害更为严重。通过抽取设备中的证书我们可以再局域网内部署其他恶意设备，进一步观察流量，扫描其他设备中的漏洞。攻击者可以以Nest为中心向其他设备辐射。突然之间，曾经的自主学习的Nest转变为一个不仅能够报告确定家或者办公室中居民的行为，而且还能报告他们的网络活动和提供不引起注意的局域网后门的间谍。

然而，从积极的意义上考虑这一点，上述的后门可以为合法用户阻止Nest未经允许搜集用户信息和扩展设备功能提供了方式。我们是否应该为了保护自己的隐私，加入未包含的功能而hack我们买的设备，这一点是有争议的。

+ ***可能的解决方法—信任链***

以下是解决能够危害Nest这个固有问题的初步的解决方法。

为了建立合适的信任链，设备必须认证从一开始就运行的代码。这意味着微处理器必须认证第一阶段的bootloader，在这里是x-loader，必须明确的认证它尝试运行的代码。进一步的，在单元中运行的任何代码必须被它的launcher认证。Nest中的处理器不支持这个德州仪器称之为安全引导（secure boot）的功能。然而，同样的供应商提供了可选安全引导的自定义的核，但是这并不是一个“现成的”（off  the  shelf ）解决方法。需要达到从最小进货量并且有安装费用，这就可能并不是有限的时间和资金的市场所想要的。

安全引导使用一个嵌入到主处理器单元中的一个密钥认证第一阶段bootloader。将key嵌入芯片不是从未听闻的，如很多消费电子设备，比如游戏机和现代基于UEFI安全引导的PC都是这么做的。这是势在必行的，然而，如果使用对称算法，这些key必须保存在安全的位置，远离设备外围软件集所达到的范围。如果使用非对称验证算法，最后一个要求就不是那么重要。

一个关于保护用户区的问题在这里被提出。对于这个有两个解决办法。第一个方法是只加载和执行签名的二进制文件。这就要求kernel要有自定义的loader以在文件被执行前进行认证。另一个方法是加密文件系统。使用这个方法，攻击者在没有解密之前不能外部改变。如果后一种方法被采用，微处理器中解密必须动态的执行。由于处理器必须定制以支持安全引导，进行实时加解密的引擎可以被使用以加速进程。

更进一步的，保护处理器-SDRAM通道是需要的，因为它同样也可以被攻击。标记运行页面和空中页面加密变为必须。同时，加密必须在处理器中进行，并且对软件透明以是基于硬件的与上述类似的方法可以被使用。

+ ***结论***

在详细的分析了Nest的硬件基本信息后，我们证明了如我们演示的连接boot过程的backdoor是可以被攻击者使用来安装恶意固件。由于攻击发生在加载主板用户区之前，部署的固件认证不能发现和阻止这个入侵。攻击载荷可以潜在的允许攻击者远程搜集网络流量，进一步危害其他节点。
除了Nest之外，我们相信大多数现在的IoT和可穿戴设备有着相同的隐患，缺乏必要的硬件保护以避免相似的攻击。未来的工作中，我们会进一步分析Wifi 和ZigBee模块以检查这些通信模块中是否包含后门，以允许远程攻击。

---
layout: post
title: Android M Preview权限机制
---

***  
　　Android M preview 引入了一套新的应用权限模型，可以简化用户安装和更新应用的过程。当应用程序运行在支持这一模型的6.0系统下，用户在安装或更新应用时不需要授予应用任何权限。App在运行时需要某些权限是请求权限，系统为用户显示一个对话框，询问用户是否授予权限。支持新的权限模型的应用依然可以安装在旧版本的android上，使用旧的权限模型。
***
## Overview

* 权限声明的时候还是跟之前的android版本相同；
* 权限被根据功能分为权限组。
* 在安装时只被授予特定的权限。用户安装或者更新应用时，被授予manifest中在PROTECTION_NORMAL下的所有权限。系统可能会授予应用signature permissions。在安装时，用户不会被提示授予任何权限。
* 用户授权在运行时。

## 开发中对新模型的适应
* 要经常检查permission。当应用执行需要权限的操作时，总会去检查是否具有了这个权限。如果没有，就会请求授权。不用检查在PROTECTION_NORMAL下的权限。
* 优雅的处理未被授权的情况。如果一个应用未被授予合适的权限，就应改对其结果进行清晰的处理。
* 权限是可撤销的。用户可以随时撤销任何权限。如果用户撤销了应用的一个权限，应用是不通知的。因此，当应用又要执行需要这项权限的操作时，应用就会出现提示。

## 权限组

　　相关的权限被分为权限组，允许用户使用一个操作就可以授权相关的权限。一个应用每一个权限组只需要一次授权。如果应用随后请求同一权限组中的权限，系统会自动授权，不需要用户操作。举个例子，如果应用需要SEND_SMS 和 RECEIVE_SMS权限，这两个是android.permission-group.SMS权限组中的。当应用需要发送短信的时候，请求SEND_SMS权限，弹出对话框让用户选择。如果用户允许，系统授予SEND_SMS权限。稍后系统请求RECEIVE_SMS权限时，系统会自动授予。因为用户已经授予相同权限组中的权限了。

## 系统组件和signature permission
　　通常，当安装一个应用时，系统只授权manifest下PROTECTION_NORMAL下的所有权限，但是在某些情况下会授予应用更多权限：

* 系统组件自动被授予manifest下的所有权限
* 如果应用请求manifest下PROTECTION_SIGNATURE下的权限，并且应用被使用声明这些权限所使用的证书相同的证书所签名，系统在安装的时候就会授予这些权限。应用在运行时不能请求这些权限。

## Permission vs intents

　　当执行一个操作时，请求权限或者使用intent都是可行的。比如照照片。既可以请求android.permission.CAMERA权限，也可以使用ACTION_IMAGE_CAPTURE intent调用系统相机请求拍照。

　　使用这两种方式的优点和缺点：

* 使用 permission

　　1)执行该操作时，应用程序完全控制用户体验。这种控制增加了任务的复杂性，因为需要设计一个合适的UI

　　2)当第一次操作时，用户被提醒一次授权请求。之后应用就可以执行操作，而不需要任何交互。然而如果用户不授权或者之后取消授权，应用就不能执行操作。

* 使用intent：

　　1) 不需要为操作设计UI。处理intent的应用负责UI。然而这意味着用户体验就不受你的控制了。用户可能与你看不到的应用进行交互。

　　2) 如果用户不适用默认应用处理intent，系统就会提示用户选择处理的应用。如果用户没有指定一个默认应用，那么每一次执行该操作时。都可能需要点一个额外的对话框。

